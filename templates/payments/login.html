{% comment %} <!DOCTYPE html>
<html>
<head>
  <title>로그인</title>
</head>
<body>
  <h2>로그인</h2>
  <form id="login-form">
    <label>Username: <input type="text" id="username" /></label><br>
    <label>Password: <input type="password" id="password" /></label><br>
    <button type="submit">로그인</button>
  </form>

  <script>
  // 1. 로그인
  document.getElementById("login-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const username = document.getElementById("login-username").value;
    const password = document.getElementById("login-password").value;

    const response = await fetch("/api/token/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });

    const result = await response.json();
    console.log("✅ 로그인 응답:", result);

    if (result.access) {
      localStorage.setItem("access_token", result.access);
      alert("로그인 성공!");
      location.reload();
    } else {
      alert("로그인 실패");
      console.log(result);
    }
  });

  // 2. 회원가입
  document.getElementById("register-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const username = document.getElementById("register-username").value;
    const password = document.getElementById("register-password").value;

    const response = await fetch("/api/register/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });

    if (response.ok) {
      alert("회원가입 성공! 로그인 해주세요.");
      document.getElementById("login-username").value = username;
      document.getElementById("login-password").value = password;
    } else {
      alert("회원가입 실패");
      console.log(await response.json());
    }
  });

  // 3. 결제 요청
  document.getElementById("payment-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const token = localStorage.getItem("access_token");
    const orderId = "order_" + Date.now();
    const orderName = document.getElementById("order-name").value;
    const customerName = document.getElementById("customer-name").value;
    const amount = Number(document.getElementById("amount").value);

    const response = await fetch("/toss/request/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ orderId, amount, orderName })
    });

    const result = await response.json();
    console.log("결제 응답:", result);

    const toss = TossPayments("test_ck_클라이언트키");

    if (result.nextRedirectUrl) {
      toss.requestPayment("카드", {
        amount,
        orderId,
        orderName,
        customerName,
        successUrl: "http://localhost:8000/toss/success/",
        failUrl: "http://localhost:8000/toss/fail/"
      });
    } else {
      alert("결제 요청 실패");
      console.log(result);
    }
  });

  // 4. 토큰 존재 시 로그인 생략
  const access = localStorage.getItem("access_token");
  if (access) {
    document.getElementById("auth-forms").style.display = "none";
    document.getElementById("payment-section").style.display = "block";
  }

  function logout() {
    localStorage.removeItem("access_token");
    alert("로그아웃 완료");
    location.reload();
  }
</script>

</body>
</html> {% endcomment %}


<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>로그인</title>
  <link rel="stylesheet" href="/static/css/styles.css" />
</head>
<body>
  <div class="card" style="max-width:480px;margin:3rem auto;">
    <h2>로그인</h2>
    <div id="message"></div>
    <form id="login-form">
      <label>Username
        <input type="text" id="username" required />
      </label><br>
      <label>Password
        <input type="password" id="password" required />
      </label><br>
      <button type="submit">로그인</button>
    </form>
    <p>계정이 없나요? <a href="/register/">회원가입</a></p>
  </div>

  <script>
    function showMessage(msg, error=true) {
      const el = document.getElementById("message");
      el.innerHTML = `<div style="padding:10px;border-radius:6px;background:${error?'#ffe6e6':'#e6ffed'};color:${error?'#a33':'#166f3c'};">${msg}</div>`;
    }

    document.getElementById("login-form").addEventListener("submit", async function(e){
      e.preventDefault();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;

      try {
        const res = await fetch("/api/token/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.access) {
          localStorage.setItem("access_token", data.access);
          showMessage("로그인 성공!", false);
          setTimeout(() => window.location.href = "/payment-page/", 400);
        } else {
          showMessage("로그인 실패: 자격 증명 확인");
          console.log(data);
        }
      } catch (err) {
        showMessage("네트워크 오류");
        console.error(err);
      }
    });
  </script>
</body>
</html>