name: CI/CD (Django â†’ EC2 via SSH)

on:
  push:
    branches: [ "main" ]   # í•„ìš”ì‹œ dev ë“± ì¶”ê°€
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpass
          MYSQL_DATABASE: test_db
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_pass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system deps for mysqlclient
        run: sudo apt-get update && sudo apt-get install -y default-libmysqlclient-dev

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        env:
          SECRET_KEY: test-secret-key
          DEBUG: "True"
          DB_ENGINE: django.db.backends.mysql
          DB_NAME: test_db
          DB_USER: test_user
          DB_PASSWORD: test_pass
          DB_HOST: 127.0.0.1
          DB_PORT: "3306"
        run: |
          python manage.py test

  deploy:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: SSH into EC2 and deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: 13.124.158.185        # ğŸ‘‰ EC2 í¼ë¸”ë¦­ IP
          username: ubuntu   # ğŸ‘‰ ë³´í†µ ubuntu
          key: ${{ secrets.PROJECT2PEM }}      # ğŸ‘‰ .pem í‚¤ ë‚´ìš©
          script: |
            set -e

            # 1) í•„ìˆ˜ íŒ¨í‚¤ì§€
            sudo apt-get update -y
            sudo apt-get install -y git docker.io docker-compose-plugin

            # 2) ì•± ë””ë ‰í† ë¦¬ ì¤€ë¹„
            APP_DIR="/home/ubuntu/app"    
            REPO_URL="https://github.com/likelion-python-16/team_1_project_2.git"     # ğŸ‘‰ ê¹ƒí—ˆë¸Œ repo ì£¼ì†Œ
            if [ ! -d "$APP_DIR" ]; then
              git clone "$REPO_URL" "$APP_DIR"
            fi

            # 3) ìµœì‹  ì½”ë“œ ë°›ê¸°
            cd "$APP_DIR"
            git fetch --all
            git reset --hard origin/main

            # 4) .env ë°˜ì˜
            echo "${{ secrets.MY_PROD_ENV }}" > .env

            # 5) Docker Compose ë¹Œë“œ & ì¬ê¸°ë™
            docker compose pull || true
            docker compose up -d --build

            # 6) ë§ˆì´ê·¸ë ˆì´ì…˜/ì •ì íŒŒì¼ (web ì„œë¹„ìŠ¤ëª… í™•ì¸ í•„ìš”)
            docker compose exec -T web python manage.py migrate --noinput
            docker compose exec -T web python manage.py collectstatic --noinput